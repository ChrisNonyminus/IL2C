<!--
////////////////////////////////////////////////////////////////////////////
//
// IL2C - A translator for ECMA-335 CIL/MSIL to C language.
// Copyright (c) Kouji Matsui (@kozy_kekyo, @kekyo@mastodon.cloud)
//
// Licensed under Apache-v2: https://opensource.org/licenses/Apache-2.0
//
////////////////////////////////////////////////////////////////////////////
-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(OS)' == 'Windows_NT'">
    <IL2CNativeCompilerDefaultFlags>$(_IL2C_GCC_DefaultFlags) -static-libgcc</IL2CNativeCompilerDefaultFlags>
    <IL2CNativeCompilerConditionalFlags Condition="'$(IL2CConfiguration)' == 'Debug'">$(_IL2C_GCC_DebugFlags)</IL2CNativeCompilerConditionalFlags>
    <IL2CNativeCompilerConditionalFlags Condition="'$(IL2CConfiguration)' == 'Release'">$(_IL2C_GCC_ReleaseFlags)</IL2CNativeCompilerConditionalFlags>
    <IL2CNativeMainTemplatePath Condition="'$(OutputType)' == 'WinExe'">$(_IL2C_WinExeMainTemplatePath)</IL2CNativeMainTemplatePath>
  </PropertyGroup>

  <UsingTask
    TaskName="_IL2C_Move_GCC4_MinGW32_PackedToolchain"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <From ParameterType="Microsoft.Build.Framework.ITaskItem" Required="true" />
      <To ParameterType="Microsoft.Build.Framework.ITaskItem" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System"/>
      <Using Namespace="System.IO"/>
      <Using Namespace="System.Collections"/>
      <Code Type="Fragment" Language="cs">
<![CDATA[
        var toPath = Path.GetFullPath(To.ItemSpec);
        if (!Directory.Exists(toPath))
        {
            try
            {
                Directory.Move(
                    Path.GetFullPath(From.ItemSpec),
                    toPath);
            }
            catch
            {
                // Maybe this is race condition for multiple execution, but can ignore this situation.
            }
        }
]]>
      </Code>
    </Task>
  </UsingTask>

  <!-- Extract toolchain 7zip archive only once. -->
  <Target Name="_IL2C_Extract_GCC4_MinGW32_PackedToolchainArchive" BeforeTargets="IL2CBuild"
    Condition="!Exists($(_IL2C_GCC4_MinGW32_NativeToolchainPath))">
      
    <PropertyGroup>
      <_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive>$([System.IO.Path]::Combine('$(_IL2C_GCC4_MinGW32_NativeToolchainBasePath)','$([System.Guid]::NewGuid().ToString())'))</_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive>
    </PropertyGroup>
      
    <MakeDir Directories="$(_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive)" />
    <Exec WorkingDirectory="$(_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive)"
      Command="&quot;$(_IL2C_GCC4PackedToolchainArchivePath)&quot;" />
    <_IL2C_Move_GCC4_MinGW32_PackedToolchain
      From="$([System.IO.Path]::Combine('$(_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive)','$(_IL2C_GCC4_MinGW32_NativeToolchainName)'))"
      To="$(_IL2C_GCC4_MinGW32_NativeToolchainPath)" />
    <RemoveDir Directories="$(_IL2C_TemporaryNameForExtractionGCC4PackedToolchainArchive)" />
  
  </Target>
</Project>
