<!--
////////////////////////////////////////////////////////////////////////////
//
// IL2C - A translator for ECMA-335 CIL/MSIL to C language.
// Copyright (c) Kouji Matsui (@kozy_kekyo, @kekyo@mastodon.cloud)
//
// Licensed under Apache-v2: https://opensource.org/licenses/Apache-2.0
//
////////////////////////////////////////////////////////////////////////////
-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- ============================================================================= -->
  <!-- Common -->
    
  <PropertyGroup>
    <IL2CEnableNativeCompile Condition="'$(IL2CEnableNativeCompile)' == ''">true</IL2CEnableNativeCompile>
    <IL2CDebugInformation Condition="'$(IL2CDebugInformation)' == ''">Full</IL2CDebugInformation>
    <IL2CReadSymbols Condition="'$(IL2CReadSymbols)' == ''">true</IL2CReadSymbols>
    <IL2CEnableCpp Condition="'$(IL2CEnableCpp)' == ''">false</IL2CEnableCpp>
    <IL2CEnableBundler Condition="'$(IL2CEnableBundler)' == ''">false</IL2CEnableBundler>
    <IL2CTargetPlatform Condition="'$(IL2CTargetPlatform)' == ''">Generic</IL2CTargetPlatform>
    <IL2CBuildTrace Condition="'$(IL2CBuildTrace)' == ''">false</IL2CBuildTrace>
  </PropertyGroup>

  <!-- ============================================================================= -->
  <!-- Common (internal) -->
    
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' != '')">
    <_IL2C_PlatformName>$(MicrosoftNETBuildTasksTFM)</_IL2C_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' == '') AND ('$(BundledNETCoreAppTargetFrameworkVersion)' != '')">
    <_IL2C_PlatformName Condition="$(BundledNETCoreAppTargetFrameworkVersion) &gt;= 5.0">net$(BundledNETCoreAppTargetFrameworkVersion)</_IL2C_PlatformName>
    <_IL2C_PlatformName Condition="$(BundledNETCoreAppTargetFrameworkVersion) &lt; 5.0">netcoreapp$(BundledNETCoreAppTargetFrameworkVersion)</_IL2C_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="('$(MSBuildRuntimeType)' == 'Core') AND ('$(MicrosoftNETBuildTasksTFM)' == '') AND ('$(BundledNETCoreAppTargetFrameworkVersion)' == '')">
    <_IL2C_PlatformName>netcoreapp2.0</_IL2C_PlatformName>
  </PropertyGroup>
  <PropertyGroup Condition="'$(MSBuildRuntimeType)' != 'Core'">
    <_IL2C_PlatformName>net45</_IL2C_PlatformName>
  </PropertyGroup>

  <PropertyGroup>
    <_IL2C_ToolingDir>$([System.IO.Path]::Combine('$(_IL2C_ScriptBaseDir)','..','tools','$(_IL2C_PlatformName)'))</_IL2C_ToolingDir>
  </PropertyGroup>

  <!-- ============================================================================= -->

  <!-- Custom inlined task -->
  <UsingTask
    TaskName="_IL2C_GetCombinedReferencesBasePath"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <References ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <CombinedReferencesBasePath Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System"/>
      <Using Namespace="System.IO"/>
      <!-- HACK: Will cause compilation error by using `System.Collection.Generic` and/or `System.Linq` on MacOS
           (Maybe related both mono environment and unreferenced core assembly on `RoslynCodeTaskFactory`) -->
      <Using Namespace="System.Collections"/>
      <Using Namespace="Microsoft.Build.Framework"/>
      <Code Type="Fragment" Language="cs">
<![CDATA[
        var candidates = new Hashtable();
        foreach (var item in References)
        {
            if (!string.IsNullOrEmpty(item.ItemSpec))
            {
                var path = Path.GetDirectoryName(Path.GetFullPath(item.ItemSpec));
                candidates[path] = path;
            }
        }
        var pathList = new object[candidates.Keys.Count];
        candidates.Keys.CopyTo(pathList, 0);
        CombinedReferencesBasePath = string.Join(";", pathList);
]]>
      </Code>
    </Task>
  </UsingTask>

  <!-- ============================================================================= -->

  <!-- Custom target at after compile process -->
  <Target Name="IL2CBuild" AfterTargets="PostBuildEvent">

    <PropertyGroup>
      <IL2CTargetAssemblyFileName Condition="'$(IL2CTargetAssemblyFileName)' == ''">$(TargetFileName)</IL2CTargetAssemblyFileName>
      <IL2CTargetAssemblyPath Condition="'$(IL2CTargetAssemblyPath)' == ''">$([System.IO.Path]::Combine('$(ProjectDir)','$(OutputPath)','$(IL2CTargetAssemblyFileName)'))</IL2CTargetAssemblyPath>
      <IL2CAssemblyPaths Condition="'$(IL2CAssemblyPaths)' != ''">$([System.String]::Concat('$(IL2CAssemblyPaths)',';','$(IL2CTargetAssemblyPath)').split(';'))</IL2CAssemblyPaths>
      <IL2CAssemblyPaths Condition="'$(IL2CAssemblyPaths)' == ''">$(IL2CTargetAssemblyPath)</IL2CAssemblyPaths>
      <IL2COutputPath Condition="'$(IL2COutputPath)' == ''">$([System.IO.Path]::Combine('$(ProjectDir)','$(OutputPath)','IL2C'))</IL2COutputPath>
      <IL2COutputNativePath Condition="'$(IL2COutputNativePath)' == ''">$([System.IO.Path]::Combine('$(ProjectDir)','$(OutputPath)','IL2C','$(TargetName)'))</IL2COutputNativePath>
    </PropertyGroup>

    <PropertyGroup>
      <IL2CBuildToolingRuntimeName Condition="'$(IL2CBuildToolingRuntimeName)' == ''">$(_IL2C_RuntimeName)</IL2CBuildToolingRuntimeName>
      <IL2CBuildToolingDir Condition="'$(IL2CBuildToolingDir)' == ''">$([System.IO.Path]::GetFullPath('$(_IL2C_ToolingDir)'))</IL2CBuildToolingDir>
      <IL2CBuildToolingPath Condition="'$(IL2CBuildToolingPath)' == ''">$([System.IO.Path]::Combine('$(IL2CBuildToolingDir)','$(_IL2C_ExecutableName)'))</IL2CBuildToolingPath>
    </PropertyGroup>
      
    <!-- ======================================================== -->
    <!-- Resolving final declarations -->
   
    <PropertyGroup Condition="'$(IL2CNativeCompiler)' == ''">
      <IL2CNativeCompiler>$(_IL2C_GCC_Compiler)</IL2CNativeCompiler>
      <IL2CNativeCompilerDefaultFlags Condition="'$(IL2CNativeCompilerDefaultFlags)' == ''">$(_IL2C_GCC_DefaultFlags)</IL2CNativeCompilerDefaultFlags>
      <IL2CNativeCompilerFlags Condition="('$(IL2CConfiguration)' == 'Debug') AND ('$(IL2CNativeCompilerFlags)' == '')">$(_IL2C_GCC_DebugFlags)</IL2CNativeCompilerFlags>
      <IL2CNativeCompilerFlags Condition="('$(IL2CConfiguration)' == 'Release') AND ('$(IL2CNativeCompilerFlags)' == '')">$(_IL2C_GCC_ReleaseFlags)</IL2CNativeCompilerFlags>
      <IL2CNativeArchiver>$(_IL2C_GCC_Archiver)</IL2CNativeArchiver>
    </PropertyGroup>
   
    <PropertyGroup>
      <_IL2C_BuildTraceOption Condition="$(IL2CBuildTrace)">-t</_IL2C_BuildTraceOption>
      <IL2COutputNativePath Condition="'$(OutputType)' == 'Library'">$(IL2COutputNativePath).a</IL2COutputNativePath>
      <IL2COutputNativePath Condition="('$(OutputType)' != 'Library') AND ('$(OS)' == 'Windows_NT')">$(IL2COutputNativePath).exe</IL2COutputNativePath>
    </PropertyGroup>

    <PropertyGroup Condition="$(IL2CEnableNativeCompile)">
      <_IL2C_NativeCompilerOption>--compiler=&quot;$(IL2CNativeCompiler)&quot;</_IL2C_NativeCompilerOption>
      <_IL2C_NativeCompilerFlagsOption>--compilerFlags=&quot;$(IL2CNativeCompilerDefaultFlags) $(IL2CNativeCompilerRequiredFlags) $(IL2CNativeCompilerFlags)&quot;</_IL2C_NativeCompilerFlagsOption>
      <_IL2C_NativeArchiverOption>--archiver=&quot;$(IL2CNativeArciver)&quot;</_IL2C_NativeArchiverOption>
      <_IL2C_NativeIncludeDirOption>--includeDirs=&quot;$(IL2CNativeIncludeDir)&quot;</_IL2C_NativeIncludeDirOption>
      <_IL2C_NativeLibPathOption>--libs=&quot;$(IL2CNativeLibPath)&quot;</_IL2C_NativeLibPathOption>
      <_IL2C_OutputNativePathOption>--outputNativePath=&quot;$(IL2COutputNativePath)&quot;</_IL2C_OutputNativePathOption>
      <_IL2C_OutputTypeOption>--outputType=$(OutputType)</_IL2C_OutputTypeOption>
      <_IL2C_NativeOptions>$(_IL2C_OutputTypeOption) $(_IL2C_NativeCompilerOption) $(_IL2C_NativeCompilerFlagsOption) $(_IL2C_NativeArchiverOption) $(_IL2C_NativeIncludeDirOption) $(_IL2C_NativeLibPathOption) $(_IL2C_OutputNativePathOption)</_IL2C_NativeOptions>
    </PropertyGroup>

    <_IL2C_GetCombinedReferencesBasePath References="@(ReferencePath)">
      <Output TaskParameter="CombinedReferencesBasePath" PropertyName="_IL2C_CombinedReferenceDir" />
    </_IL2C_GetCombinedReferencesBasePath>

    <!-- ======================================================== -->
    <!-- Execute -->
   
    <Exec WorkingDirectory="$(IL2CBuildToolingDir)"
      Command="$(IL2CBuildToolingRuntimeName)&quot;$(IL2CBuildToolingPath)&quot; $(_IL2C_BuildTraceOption) --debug=&quot;$(IL2CDebugInformation)&quot; --readSymbol=&quot;$(IL2CReadSymbols)&quot; --produceCpp=&quot;$(IL2CEnableCpp)&quot; --bundler=&quot;$(IL2CEnableBundler)&quot; --target=&quot;$(IL2CTargetPlatform)&quot; --refDirs=&quot;$(_IL2C_CombinedReferenceDir)&quot; $(_IL2C_NativeOptions) &quot;$(IL2COutputPath)&quot; &quot;$(IL2CAssemblyPaths)&quot;" />

    <ItemGroup>
      <FileWrites Include="$(IL2COutputPath)\**\*.c" />
      <FileWrites Include="$(IL2COutputPath)\**\*.cpp" />
      <FileWrites Include="$(IL2COutputPath)\**\*.h" />
    </ItemGroup>
  </Target>

</Project>
